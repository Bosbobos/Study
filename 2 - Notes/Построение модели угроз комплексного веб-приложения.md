---
date: 2025-09-22
tags:
  - pentest/lab
---
Работу выполнил Коновалов Матвей, БИБ233
# Описание основных модулей (микросервисов)
## Модуль авторизации
Отвечает за:
- регистрацию;
- авторизацию;
- контроль сессий.

Есть своя БД с логинами, хэшами паролей, выданными токенами.
## Модуль общения
Отвечает за:
- поиск других людей;
- отправку сообщений;
- создание групповых чатов.

Есть своя БД со списками друзей, отправленными сообщениями, чатами.
## S3-bucket
Нужно для загрузки файлов, изображений, видео, в чатик будет просто встраиваться ссылка на объект отсюда, который заодно будет рендериться.
# Декомпозиция приложения
## Точки входа
- форма регистрации;
- форма логина;
- полученные cookies;
- присланное текстовое сообщение;
- присланный файл (exe, видео, pdf, не важно).
## Точки выхода
- БД аутентификатора;
- БД модуля общения;
- S3-bucket;
- другие люди.
## Data flow diagram
![[Построение модели угроз комплексного веб-приложения-1758551329333.webp]]
1. Пользователь регается - через сервис аутентификации создаётся по записи в Auth БД (с логином и хэшем пароля) и БД с пользователями (с логином и инфой об акках)
2. Пользователь логинится - через сервис аутентификации находится запись в Auth БД с таким логином и хэшем пароля; если совпадает, то переходим к шагу 3
3. Сервис аутентификации создаёт session token, записывает её в Auth БД и cookie пользователя
4. С session token-ом, переданным через cookie, пользователь может установить websocket-соединение с сервисом общения
5. При установленном соединении пользователь может отправлять сообщения, которые через сервис общения сохраняются в чат бд и отправляются другим пользователям в чате
6. Если пользователь отправляет файл в чат, то тот через сервис общения отправляется в S3-bucket, а к сообщению прикпляется ссылка на этот контент там; оттуда по ссылке это рендерится у других пользователей
7. При поиске других пользователей через сервис общения отправляется select-запрос в бд пользователей (для безопасности отвязанную от Auth БД)
## Активы и уровни доступа

| ID  | Имя                      | Описание                                                                      | Уровни доверия                                        |
| --- | ------------------------ | ----------------------------------------------------------------------------- | ----------------------------------------------------- |
| 1   | Пользовательские         | Принадлежат одному/нескольким пользователям                                   |                                                       |
| 1.1 | Логин, хэш пароля        | Сохранены в Auth  БД, помогают логиниться                                     | 1)Auth БД; 2)Сервис аутентификации; 3)Пользователь;   |
| 1.2 | Токен сессии             | Сохранется в Auth БД и в cookies, используется чтобы не логиниться каждый раз | 1)Auth БД; 2)Сервис аутентификации; 3)Пользователь;   |
| 2   | Принадлежащие чату       | Доступны всем пользователям в конкретном чате                                 |                                                       |
| 2.1 | Сообщения в чате         | Хранятся в чат БД                                                             | 1)Чат БД; 2)Сервис общения; 3)Пользователи в чате;    |
| 2.2 | Вложения в чате          | Хранятся в S3-bucket                                                          | 1)S3-bucket; 2)Сервис общения; 3)Пользователи в чате; |
| 3   | Принадлежащие серверу    | Доступны только админу                                                        |                                                       |
| 3.1 | Логин, хэш пароля админа | Сохранены в Auth БД                                                           | 1)Auth БД; 2)Сервис аутентификации; 3)Админ;          |
| 3.2 | Логи                     | Сохранены в txt файлике на 40тб (тру стори)                                   | 1)Админ; 2)Сервисы сервера(write-only)                |
# Наиболее интересные сценарии использования приложения
Разумеется, как для ИБшника, самые интересные сценарии связаны с потенциальными атаками на приложение.
1. Через cookies прокинуть на сервер какую-то инфу, которую прокинуть должно быть нельзя, потому что едва ли мы будем сильно валидировать cookies (если мы не совсем умные, конечно).
	К примеру, если мы затем будем искать токен сессии в базе данных, можно попробовать прокинуть в cookie SQL-инъекцию и украсть сессию другого человека (а то и админа, если подумаем над запросом пару минут).
	Основной способ защититься - стандартная защита от SQL-инъекций - prepared statements и ORM. И, поскольку cookies находятся под контролем пользователя, им не доверяем так же сильно, как информации из форм и других форм инпута пользователя.
2. В текстовое сообщение можем прокинуть XSS-атаку, тогда это получится и вовсе Stored XSS, который может атаковать всех пользователей в чате.
	Самый базовый сценарий атаки - угнать так сессии пользователей из чата.
	Способы защиты тоже базовые - использование кодирования, cookies-ам проставить HttpOnly.
3. В неправильно настроенном S3-bucket один пользователь, закинув вредоносный файл и каким-то образом его запустив, может получить доступ к файлам других пользователей.
	Чтобы этого избежать, достаточно правильно настроить наш bucket и применить специфичные к нему политики безопасности.
# Определение угроз по STRIDE

| Актив             | STRIDE | Угроза                            | Пример уязвимости                                 |
| ----------------- | ------ | --------------------------------- | ------------------------------------------------- |
| Логин, хэш пароля | S      | Логин не в свой акк               | Незащищённость от брутфорса!!                     |
|                   | T      | Смена пароля другому пользователю | Недостаточная аутентификация в форме смены пароля |
|                   | I      | Утечка БД логинов и хэшей паролей | Стандартные данные для вх                         |
|                   |        |                                   |                                                   |
